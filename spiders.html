<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.2.1/dist/css/bootstrap.min.css" integrity="sha384-GJzZqFGwb1QTTN6wy59ffF1BuGJpLSa9DkKMp0DgiMDm4iYMj70gZWKYbI706tWS" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.12.1/css/jquery.dataTables.min.css" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.datatables.net/fixedcolumns/4.1.0/css/fixedColumns.dataTables.min.css" crossorigin="anonymous">

    <title>All the Places Spiders</title>
    <style>
        body {
            font-size: 12px;
            padding: 10px 100px;
        }

        .stability-box {
            width: 10px;
            height: 10px;
            border-radius: 10px;
            background-color: grey;
            position: relative;
            right: 0;
            margin: auto;
        }
    </style>
</head>
<body>
    <table id="spider-table" class="display compact" style="width:100%"></table>

<script src="https://code.jquery.com/jquery-3.6.0.min.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.6/dist/umd/popper.min.js" integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.2.1/dist/js/bootstrap.min.js" integrity="sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k" crossorigin="anonymous"></script>
<script src="https://cdn.datatables.net/1.12.1/js/jquery.dataTables.min.js" crossorigin="anonymous"></script>
<script src="https://cdn.datatables.net/fixedcolumns/4.1.0/js/dataTables.fixedColumns.min.js" crossorigin="anonymous"></script>
<script>
    var NUM_BUILDS = 10; // max number of builds/runs/columns
    var MAX_STABILITY = 500; // don't grade a standard deviation any more than this.

    // Function to process a single history entry
    async function processHistoryEntry(entry) {
        // Make the request for the `stats_url` of this entry
        const historyEntryResponse = await window.fetch(entry.stats_url)

        // Parse the response as JSON data and return a POJO
        const historyEntry = await historyEntryResponse.json()

        historyEntry['run_id'] = entry.start_time.replace(/T.*$/,"");

        // Return the individual history entry from this function
        return historyEntry
    }

    // Fetch the recent history
    async function fetchHistoryEntries() {
        try {
            // Make the request for `history.json`
            const historyResponse = await window.fetch('https://data.alltheplaces.xyz/runs/history.json')

            // Parse the response as JSON data and return a POJO
            const history = await historyResponse.json()

            // Sort the history by start_time and just use the first N
            history
                .sort((a, b) => new Date(a.start_time) < new Date(b.start_time) ? 1 : -1)
                .splice(NUM_BUILDS)

            // Wait for each history entry to process (see processHistoryEntry function above)
            // `historyEntries` will be an array of the result of calling `processHistoryEntry` above
            // with the 5 entries returned from the sort and splice.
            return await Promise.all(history.map(processHistoryEntry))
        } catch (error) {
            // Any errors thrown during any of the above code will be caught here
            console.log('There was an error: ', error)
        }
    }

    function getColorGradient(percentage) {
        const red = (percentage > 50 ? 1 - 2 * (percentage - 50) / 100.0 : 1.0) * 255,
              green = (percentage > 50 ? 1.0 : 2 * percentage / 100.0) * 255,
              blue = 0.0;
        return `rgb(${red},${green},${blue})`;
    }

    // Call the main function.  If you needed to await the results of this,
    // you would need to call if from another async function.
    fetchHistoryEntries().then(recentHistories => {
        let knownBuilds = [];
        let buildsBySpider = {};

        // Re-pivot the build data by spider
        recentHistories.forEach(historyEntry => {
            knownBuilds.push(historyEntry.run_id)

            historyEntry.results.forEach(resultEntry => {
                if (!buildsBySpider[resultEntry.spider]) {
                    buildsBySpider[resultEntry.spider] = {}
                }

                buildsBySpider[resultEntry.spider][historyEntry.run_id] = {
                    errors: resultEntry.errors,
                    features: resultEntry.features,
                    elapsed: resultEntry.elapsed_time,
                }
            })
        })

        // Build the HTML
        // Start with the header
        let columnNames = [
            {title: "Spider"},
            {
                title: "Stability",
                render: (data, type, row, meta) => {
                    // Get a copy of the array with just the build counts
                    let builds = row.slice(2);
                    // Count the number of non-null builds
                    const numValidBuilds = builds.reduce((partialCount, a) => a === null ? partialCount + 0 : partialCount + 1, 0);
                    const sumFeatures = builds.reduce((partialSum, a) => partialSum + a);
                    const mean = (numValidBuilds === 0) ? 0 : (sumFeatures / numValidBuilds);
                    let sumSqDeviations = builds.reduce((partial, a) => {
                        let dev = a - mean;
                        return partial + (dev * dev);
                    });
                    let variance = sumSqDeviations / numValidBuilds;
                    let stDev = Math.sqrt(variance);
                    let perc = 100 - ((Math.min(stDev, MAX_STABILITY) / MAX_STABILITY ) * 100);
                    return type === "display" ? `<div class="stability-box" style="background-color: ${getColorGradient(perc)}"></div>` : stDev;
                },
            },
        ]

        let numberedColumnIndices = [1];

        knownBuilds.forEach(entry => {
            numberedColumnIndices.push(columnNames.length);
            columnNames.push({title: entry});
        });

        let rows = [];

        Object.entries(buildsBySpider).forEach(entry => {
            let row = [
                entry[0],
            ]

            knownBuilds.forEach(buildName => {
                if (entry[1][buildName]) {
                    row.push(entry[1][buildName].features);
                } else {
                    row.push(null);
                }
            });

            row.splice(1, 0, null);
            rows.push(row);
        });

        // initialise datatable on the html we built
        var dataTable = $("#spider-table").DataTable({
            paging: false,
            scrollY: 700,
            scrollX: true,
            scrollCollapse: true,
            data: rows,
            columns: columnNames,
            rowCallback: (row, data) => {
                $('td', row).slice(2).map((i, c) => {
                    if (data[i+2] === 0) {
                        $(c).css("background-color", "pink");
                    }
                });
            },
            columnDefs: [
                { "type": "num", "className": "text-right", "targets": numberedColumnIndices }
            ],
            fixedColumns: true,
        });
    });
</script>
</body>
</html>
